<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thumbs Down — Forest Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@800;900&family=Pacifico&display=swap" rel="stylesheet">
<style>
:root{
--beige:#F3EADD; --black:#0B0B0C; --black-2:#121316;
--fg:#ECECEC; --muted:#C0C6CD;
--forest:#3BA164; /* forest/grass green (logo + table DOWN) */
--grey:#8D9197; /* table UP grey */
--chip:#121316; --chip-b:#1C1F26;
--shadow:0 18px 50px rgba(0,0,0,.35);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%}
body{background:var(--beige);color:var(--fg);font:16px/1.35 Manrope,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}

.wrap{min-height:100%;display:grid;place-items:start;gap:16px;padding:18px 18px 28px;max-width:820px;margin:0 auto}

/* ===== TOP LOGO (one-line header; tagline below right) ===== */
.logoWrap{width:100%;display:grid;grid-template-rows:auto auto;row-gap:6px}
.logoHeader{display:flex;align-items:center;gap:12px;flex-wrap:nowrap}
.logoMark{width:62px;height:62px;display:grid;place-items:center;flex:0 0 auto}
.logoMark svg{width:62px;height:62px;display:block;fill:var(--forest)} /* flat DOWN thumb */
.title{
margin:0;
font-size:clamp(28px, 6vw, 42px); /* scales on small screens, stays one line */
font-weight:900; letter-spacing:.6px; color:#121417; white-space:nowrap
}
.tag{margin:0;color:#2B2D30;font-family:Pacifico,cursive;font-size:18px;justify-self:end}

/* ===== CARD ===== */
.card{width:100%;background:var(--black);border:1px solid rgba(255,255,255,.06);
border-radius:22px;box-shadow:var(--shadow);padding:18px 18px 26px}
.header-gap{height:10px}

/* ===== TABLE (visual board) ===== */
.table-wrap{display:grid;place-items:center}
.table{
width:min(100%,740px);aspect-ratio:16/10;position:relative;border-radius:26px;
background:radial-gradient(70% 100% at 50% 30%, rgba(255,255,255,.06), transparent 60%), linear-gradient(180deg,#13151B,#0D0E12);
border:1px solid rgba(255,255,255,.08);
box-shadow:inset 0 10px 24px rgba(255,255,255,.03), inset 0 -10px 22px rgba(0,0,0,.45), var(--shadow)
}
.edge{position:absolute;inset:7% 5%;border-radius:999px;border:2px solid rgba(255,255,255,.12);
box-shadow:inset 0 0 0 6px rgba(255,255,255,.03);pointer-events:none}
.board{position:absolute;inset:0}

/* ===== CHIPS (seats around table) ===== */
.chip{
position:absolute;transform:translate(-50%,-50%);display:grid;place-items:center;gap:4px;
width:66px;height:66px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);
box-shadow:0 12px 24px rgba(0,0,0,.45);cursor:pointer;user-select:none;touch-action:manipulation;
transition:transform .18s ease
}
.chip:active{ transform:translate(-50%,-50%) scale(.97) }
.nm{font-weight:900;font-size:10px;text-align:center;color:#E6EBEF;padding:0 6px;max-width:58px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chip.disabled{opacity:.55;cursor:not-allowed}

/* Flat thumb icon (single simple SVG; color via currentColor) */
.thumb{display:grid;place-items:center;width:26px;height:26px;position:relative}
.thumb svg{width:26px;height:26px;display:block;fill:currentColor;transition:transform .28s ease, color .25s ease}
/* States: start UP/grey -> tap -> DOWN/forest */
.thumb.up svg{ transform:rotate(180deg); color:var(--grey) }
.thumb.down svg{ transform:rotate(0deg); color:var(--forest) }

/* Wobble for invalid taps */
@keyframes wobble{0%,100%{transform:translate(-50%,-50%)}25%{transform:translate(calc(-50% - 6px),-50%)}75%{transform:translate(calc(-50% + 6px),-50%)}}
.chip.wobble{ animation:wobble .28s ease }

/* Host controls: small, side-by-side, right-aligned */
.controls{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.btn{border:0;border-radius:10px;padding:9px 12px;font:inherit;font-weight:900;cursor:pointer}
.btn-primary{background:#0EA5E9;color:#fff}
.btn-ghost{background:#121316;color:#e6e9ef;border:1px solid rgba(255,255,255,.12)}
.btn.small{padding:8px 10px;font-size:13px}

/* Toast: fades out after 2s */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
background:#121316;border:1px solid rgba(255,255,255,.12);
padding:10px 14px;border-radius:12px;font-weight:900;z-index:50;
opacity:0; transition:opacity .25s ease}
.toast.show{opacity:1}

/* Modal (penultimate) */
.modal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);z-index:60}
.sheet{width:min(92%,560px);background:var(--black);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:var(--shadow);display:grid;gap:10px}
.h{font-weight:900;font-size:18px}
.p{color:#C0C6CD;font-size:13px}
.row{display:grid;grid-template-columns:1fr auto;gap:8px}
.row input{background:#121316;border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#E6E9EF;padding:12px}

/* Player-only footer: Host a game + store badges (inactive) */
.player-footer{margin-top:12px;color:#2B2D30}
.badgeRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px}
.storeBadge{display:inline-flex;align-items:center;justify-content:center;height:40px;padding:0 12px;border-radius:8px;background:#111318;color:#E9ECEF;border:1px solid rgba(255,255,255,.12);opacity:.6;pointer-events:none}
.inactiveNote{margin-top:6px;font-size:12px;color:#666}
</style>
</head>
<body>
<!-- TOP LOGO -->
<div class="wrap">
<div class="logoWrap">
<div class="logoHeader">
<div class="logoMark" aria-hidden="true">
<!-- Flat thumbs-down mark (base = DOWN) -->
<svg viewBox="0 0 64 64" focusable="false">
<path d="M14 28h-6c-2.2 0-4-1.8-4-4v-8c0-2.2 1.8-4 4-4h6c2.2 0 4 1.8 4 4v8c0 2.2-1.8 4-4 4Z"></path>
<path d="M22 12h17c5.5 0 9 4.8 8.2 9.6l-1.8 10.8c-.5 3.1-3.2 5.6-6.4 5.6H35l1.1 6.8c.3 2-1 3.9-2.9 4.4-1.2.3-2.5-.1-3.3-1l-7.7-9c-1.5-1.7-2.3-3.9-2.3-6.1V16c0-2.2 1.8-4 4-4Z"></path>
</svg>
</div>
<h1 class="title">THUMBS DOWN</h1>
</div>
<p class="tag">Last to Tap Gets Punished</p>
</div>

<div class="card">
<div class="header-gap"></div>

<!-- REVEAL -->
<div id="revealView" class="hidden">
<div style="text-align:center">
<div id="headline" style="font-size:22px;font-weight:900;margin:4px 0 6px"></div>
<div id="dareLine" style="color:#C0C6CD;font-size:12px"></div>
<div id="meta" style="color:#C0C6CD;font-size:12px"></div>
</div>
</div>

<!-- APP -->
<div id="appView">
<div id="hostMount"></div>
<div class="table-wrap hidden" id="tableWrap">
<div class="table">
<div class="edge"></div>
<div id="board" class="board"></div>
</div>
</div>
</div>
</div>

<!-- Player-only footer -->
<div id="playerFooter" class="player-footer hidden">
<div style="font-weight:900">Host a game</div>
<div class="badgeRow">
<div class="storeBadge"> App Store</div>
<div class="storeBadge">Google Play</div>
</div>
<div class="inactiveNote">Currently inactive, awaiting uploads to App Stores.</div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
</div>

<!-- HOST TEMPLATE (only when there is no ?g=) -->
<template id="hostTpl">
<div id="hostSetup" class="setup">
<div class="hint" style="margin:2px 0 10px;color:#C0C6CD">Add up to 10 friends.</div>
<div id="nameFields" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
<input placeholder="Name 1"><input placeholder="Name 2"><input placeholder="Name 3"><input placeholder="Name 4">
<input placeholder="Name 5"><input placeholder="Name 6"><input placeholder="Name 7"><input placeholder="Name 8">
<input placeholder="Name 9"><input placeholder="Name 10">
</div>
<div class="controls">
<button id="resetBtn" class="btn btn-ghost small" type="button">Reset</button>
<button id="confirmBtn" class="btn btn-primary small" type="button" disabled>Confirm</button>
</div>
</div>
</template>

<!-- PENULTIMATE MODAL (only the penultimate user sees this) -->
<template id="penultTpl">
<div class="modal" id="penultModal" role="dialog" aria-modal="true">
<div class="sheet">
<div class="h">Congratulations! You are the Punisher.</div>
<div class="p" id="penultLine2"></div>
<div class="p">Now set them their dare or task.</div>
<div class="row">
<input id="dareInput" maxlength="50" placeholder="Dare or task (≤ 50 chars)" />
<button id="confirmDare" class="btn btn-primary" type="button">Share back to your group</button>
</div>
</div>
</div>
</template>

<script>
"use strict";

/* ---------- Utilities ---------- */
const $=id=>document.getElementById(id);
const qs=new URLSearchParams(location.search);
const toast=$("toast");
function say(t,ms=2000){ // 2s fade-away
toast.textContent=t;
toast.classList.add("show");
clearTimeout(say._t);
say._t=setTimeout(()=>toast.classList.remove("show"),ms);
}
function ringPoints(N){ const L=8,R=92,T=12,B=88,cx=(L+R)/2,cy=(T+B)/2,rx=(R-L)/2,ry=(B-T)/2; const out=[]; for(let i=0;i<N;i++){const a=(2*Math.PI*i)/N-Math.PI/2; out.push({x:cx+rx*Math.cos(a),y:cy+ry*Math.sin(a)})} return out; }
function uuid(){ try{ return crypto.randomUUID() } catch(e){ return Math.random().toString(36).slice(2) } }

/* ---------- Flat thumb SVG (base = DOWN). We rotate to get UP. ---------- */
const THUMB_SVG = `
<svg viewBox="0 0 64 64" aria-hidden="true">
<path d="M14 28h-6c-2.2 0-4-1.8-4-4v-8c0-2.2 1.8-4 4-4h6c2.2 0 4 1.8 4 4v8c0 2.2-1.8 4-4 4Z"></path>
<path d="M22 12h17c5.5 0 9 4.8 8.2 9.6l-1.8 10.8c-.5 3.1-3.2 5.6-6.4 5.6H35l1.1 6.8c.3 2-1 3.9-2.9 4.4-1.2.3-2.5-.1-3.3-1l-7.7-9c-1.5-1.7-2.3-3.9-2.3-6.1V16c0-2.2 1.8-4 4-4Z"></path>
</svg>`;

/* ---------- Elements & state ---------- */
const hostMount=$("hostMount"), tableWrap=$("tableWrap"), board=$("board");
const revealView=$("revealView");
const playerFooter=$("playerFooter");

let gameId = qs.get("g") || null;
let state = null, pollTimer=null;
let me = {
isHost: !gameId,
myName: null,
tappedOnce: false,
inviteShared: false,
clientId: (()=>{ try{ let v=localStorage.getItem("td_client"); if(!v){ v=uuid(); localStorage.setItem("td_client", v); } return v; }catch(_){ return uuid(); } })(),
penultShown: false
};

/* ---------- Mount ---------- */
if (me.isHost) {
const tpl=document.getElementById("hostTpl").content.cloneNode(true);
hostMount.appendChild(tpl);
const nameFields=$("nameFields"); const confirmBtn=$("confirmBtn"); const resetBtn=$("resetBtn");

const inputs=[...nameFields.querySelectorAll("input")];
const getNames=()=>inputs.map(i=>i.value.trim()).filter(Boolean).slice(0,10);
inputs.forEach(inp=>inp.addEventListener("input",()=>{
const n=getNames(); confirmBtn.disabled=n.length<3; drawTable(n, []);
}, {passive:true}));

confirmBtn.onclick=async ()=>{
const names=getNames(); if(names.length<3){ say("Add at least 3 names"); return; }
const res=await fetch("/api/game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({names})});
const data=await res.json(); if(!res.ok){ say(data.error||"Create failed"); return; }
gameId=data.gameId; state=data.state;
history.replaceState(null,"",location.pathname+"?g="+gameId);
hostMount.innerHTML=""; // hide host UI so players don't see fields
tableWrap.classList.remove("hidden"); // show table
drawTable(state.names,state.tapped); startPolling();
say("Names confirmed. Tap your own name to share the invite.");
};

resetBtn.onclick=()=>{ location.href=location.pathname+"?ts="+Date.now(); };
} else {
// Player view
tableWrap.classList.remove("hidden");
playerFooter.classList.remove("hidden"); // only players see this footer
fetchState();
}

/* ---------- Polling ---------- */
function startPolling(){ stopPolling(); pollTimer=setInterval(fetchState,2000); window.addEventListener("focus",fetchState); }
function stopPolling(){ if(pollTimer){clearInterval(pollTimer);pollTimer=null;} window.removeEventListener("focus",fetchState); }

async function fetchState(){
if(!gameId) return;
const res=await fetch("/api/state?gameId="+encodeURIComponent(gameId));
const s=await res.json();
if(!res.ok){ say(s.error||"Connection error"); return; }
state=s;
if(state.revealed){ showReveal(); return; }
drawTable(state.names,state.tapped);
ensureNoPenultModalUnlessEligible();
}

/* ---------- Board ---------- */
function drawTable(names,tapped){
board.innerHTML=""; if(!Array.isArray(names)||!names.length) return;
const pts=ringPoints(names.length);
names.forEach((nm,i)=>{
const isDown=tapped.includes(nm);
const chip=document.createElement("div");
chip.className="chip"+(isDown?" down":"");
chip.style.left=pts[i].x+"%"; chip.style.top=pts[i].y+"%";
chip.dataset.name=nm;

const thumb=document.createElement("div");
thumb.className="thumb "+(isDown?'down':'up'); // start UP/grey
thumb.innerHTML = THUMB_SVG; // flat icon (base = DOWN)
chip.appendChild(thumb);

const label=document.createElement("div");
label.className="nm"; label.textContent=nm;
chip.appendChild(label);

chip.addEventListener("click",()=>onChipClick(nm,chip),{passive:true});
board.appendChild(chip);
});

// Local one-thumb lock (UI)
if(me.tappedOnce && me.myName){
[...board.querySelectorAll(".chip")].forEach(c=>{ if(c.dataset.name!==me.myName) c.classList.add("disabled"); });
}
}

/* Click with wobble for invalid attempts */
async function onChipClick(name, chip){
if (me.tappedOnce && me.myName && me.myName !== name){ wobble(chip); return; }
if (chip.classList.contains("down")){ wobble(chip); return; }
onTap(name, chip);
}
function wobble(el){ el.classList.remove("wobble"); void el.offsetWidth; el.classList.add("wobble"); }

/* Tap flow */
async function onTap(name,chip){
if(!gameId||!state) return; if(state.revealed) return;

// Animate UP -> DOWN (rotate to 0deg & color = forest)
const thumb = chip.querySelector(".thumb");
thumb.classList.remove("up"); thumb.classList.add("down");
thumb.querySelector('svg').style.color = getComputedStyle(document.documentElement).getPropertyValue('--forest');

me.tappedOnce=true; me.myName=name;

// Host: first tap → WhatsApp invite
if(me.isHost && !me.inviteShared && gameId){
me.inviteShared=true;
const inviteURL=location.origin+location.pathname+"?g="+encodeURIComponent(gameId);
const text=`Thumbs Down — Last to Tap Gets Punished.\n${inviteURL}`;
setTimeout(()=>{ location.href="https://wa.me/?text="+encodeURIComponent(text); }, 900);
}

// Persist on server
const res=await fetch("/api/tap",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gameId,name,clientId:me.clientId})});
const s=await res.json(); if(!res.ok){ say(s.error||"Tap failed"); await fetchState(); return; }
state=s;

maybeShowPenultimate();
drawTable(state.names,state.tapped);
}

/* Penultimate gating */
function maybeShowPenultimate(){
const remaining=state.names.length-state.tapped.length;
const iAmTapped=me.myName && state.tapped.includes(me.myName);
if(remaining===1 && iAmTapped && !me.penultShown){
const loser=state.names.find(n=>!state.tapped.includes(n))||"someone";
openPenultModal(loser); me.penultShown=true;
} else if(!(remaining===1 && iAmTapped)){ closePenultModal(); me.penultShown=false; }
}
function ensureNoPenultModalUnlessEligible(){
const remaining=state.names.length-state.tapped.length;
const iAmTapped=me.myName && state.tapped.includes(me.myName);
if(!(remaining===1 && iAmTapped)){ closePenultModal(); me.penultShown=false; }
}

/* Modal for penultimate player (new wording) */
function openPenultModal(loserName){
closePenultModal();
const tpl=document.getElementById("penultTpl").content.cloneNode(true);
document.body.appendChild(tpl);
const line2 = document.getElementById("penultLine2");
line2.textContent = `The person who didn't tap their name is ${loserName} and must be punished.`;
document.getElementById("confirmDare").onclick=async ()=>{
const dv=(document.getElementById("dareInput").value||"").trim().slice(0,50);
if(!dv){ say("Type a dare or task first"); return; }
const res=await fetch("/api/reveal",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gameId,dare:dv})});
const s=await res.json(); if(!res.ok){ say(s.error||"Reveal failed"); return; }
state=s;
const revealURL=location.origin+location.pathname+"?g="+encodeURIComponent(gameId);
const text=`👉 Click to reveal the loser:\n${revealURL}`;
location.href="https://wa.me/?text="+encodeURIComponent(text);
showReveal(); closePenultModal();
};
}
function closePenultModal(){ const m=document.getElementById("penultModal"); if(m) m.remove(); }

/* Reveal view (keeps simple wording) */
function showReveal(){
stopPolling();
$("appView").classList.add("hidden");
revealView.classList.remove("hidden");
$("headline").textContent=`Today's loser is ${state.loser||"someone"}.`;
$("dareLine").textContent=state.dare?`Dare/Task: ${state.dare}`:"";
$("meta").textContent=new Date().toLocaleString();
}

/* Polling */
function startPolling(){ stopPolling(); pollTimer=setInterval(fetchState,2000); window.addEventListener("focus",fetchState); }
function stopPolling(){ if(pollTimer){clearInterval(pollTimer);pollTimer=null;} window.removeEventListener("focus",fetchState); }

/* Errors */
window.addEventListener('error',e=>{ try{ say('Error: '+(e.message||'unknown')); }catch(_){} });
</script>
</body>
</html>
