<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thumbs Down</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{ --bg:#0b1220; --card:#0f172a; --fg:#e6e9ef; --muted:#93a3b8;
--brand:#0ea5e9; --down:#22c55e; --chip:#0d1326; --chip-b:#101a33; --shadow:0 14px 40px rgba(0,0,0,.35) }
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.3 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
.wrap{min-height:100%;display:grid;place-items:center;padding:14px}
.card{width:min(100%,740px);background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:var(--shadow);padding:14px 14px 16px}
.head{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;margin:4px 4px 8px}
.logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#22c55e,var(--brand));display:grid;place-items:center;box-shadow:0 8px 18px rgba(14,165,233,.35)}
.titles{display:grid;gap:2px}
h1{margin:0;font-size:20px;font-weight:900;letter-spacing:.2px}
.sub{margin:0;color:var(--muted);font-weight:700;font-size:12px}
.btn{border:0;border-radius:12px;padding:12px 14px;font:inherit;font-weight:900;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff;box-shadow:0 10px 22px rgba(14,165,233,.25)}
.btn-ghost{background:#0d1326;color:#e6e9ef;border:1px solid rgba(255,255,255,.12)}
.hidden{display:none}

.setup{margin:10px 2px;display:grid;gap:10px}
.hint{color:var(--muted);font-size:12px;margin-top:-2px}
.grid-names{display:grid;gap:8px;grid-template-columns:1fr 1fr}
@media (min-width:480px){ .grid-names{grid-template-columns:1fr 1fr 1fr} }
.namebox{background:#0d1326;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px}
.namebox input{width:100%;border:0;background:transparent;color:var(--fg);font:600 16px/1.2 system-ui;outline:none;padding:2px 0}
.toolbar{display:flex;justify-content:space-between;gap:8px}

.table-wrap{display:grid;place-items:center}
.table{width:min(100%,720px);aspect-ratio:16/10;position:relative;border-radius:18px;background:linear-gradient(180deg,#0f172a,#0b1220);outline:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow)}
.edge{position:absolute;inset:12% 8%;border-radius:999px;border:2px dashed rgba(255,255,255,.08);pointer-events:none}
.board{position:absolute;inset:0}
.chip{position:absolute;transform:translate(-50%,-50%);display:grid;place-items:center;gap:2px;width:58px;height:58px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);box-shadow:0 8px 18px rgba(0,0,0,.35);cursor:pointer;user-select:none;touch-action:manipulation;transition:transform .28s ease, filter .12s ease}
.chip.down{ background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.5) }
.ic{font-size:16px;transition:transform .28s ease, color .18s ease}
.chip.down .ic{ transform:rotate(180deg); color:#22c55e }
.nm{font-weight:800;font-size:10px;letter-spacing:.1px;text-align:center;color:#e6e9ef;padding:0 6px;max-width:50px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chip.disabled{opacity:.55; cursor:not-allowed; pointer-events:none}

.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0d1326;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-weight:900;z-index:50}

/* Modal */
.modal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);z-index:60}
.sheet{width:min(92%,560px);background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:var(--shadow);display:grid;gap:10px}
.h{font-weight:900;font-size:18px}
.p{color:var(--muted);font-size:13px}
.row{display:grid;grid-template-columns:1fr auto;gap:8px}
.row input{background:#0d1326;border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#e6e9ef;padding:12px}
</style>
</head>
<body>
<div class="wrap">
<div class="card">
<div class="head">
<div class="logo" aria-hidden="true">üëç</div>
<div class="titles"><h1>Thumbs Down</h1><p class="sub">Don‚Äôt Be Such a Loser</p></div>
<button id="resetBtn" class="btn btn-ghost hidden">Reset</button>
</div>

<!-- Reveal view -->
<div id="revealView" class="hidden">
<div class="reveal">
<div class="headline" id="headline"></div>
<div class="meta" id="dareLine"></div>
<div class="meta" id="meta"></div>
</div>
</div>

<!-- App view -->
<div id="appView">
<!-- Host UI mounts here (template below), players never get it -->
<div id="hostMount"></div>

<!-- Table -->
<div class="table-wrap hidden" id="tableWrap">
<div class="table">
<div class="edge"></div>
<div id="board" class="board"></div>
</div>
</div>
</div>

<div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
</div>
</div>

<!-- Host UI template (only injected with no ?g=) -->
<template id="hostTpl">
<div id="hostSetup" class="setup">
<div class="hint">Add up to 10 names, then tap Confirm.</div>
<div class="grid-names" id="nameFields">
<div class="namebox"><input placeholder="Name 1"></div>
<div class="namebox"><input placeholder="Name 2"></div>
<div class="namebox"><input placeholder="Name 3"></div>
<div class="namebox"><input placeholder="Name 4"></div>
<div class="namebox"><input placeholder="Name 5"></div>
<div class="namebox"><input placeholder="Name 6"></div>
<div class="namebox"><input placeholder="Name 7"></div>
<div class="namebox"><input placeholder="Name 8"></div>
<div class="namebox"><input placeholder="Name 9"></div>
<div class="namebox"><input placeholder="Name 10"></div>
</div>
<div class="toolbar">
<button id="confirmBtn" class="btn btn-primary" type="button" disabled>Confirm</button>
</div>
</div>
</template>

<!-- Penultimate modal template (injected ONLY for penultimate tapper) -->
<template id="penultTpl">
<div class="modal" id="penultModal" role="dialog" aria-modal="true">
<div class="sheet">
<div class="h">Congratulations, you are the last of the winners.</div>
<div class="p">Now set a DARE for <strong id="loserName"></strong>.</div>
<div class="row">
<input id="dareInput" maxlength="50" placeholder="Today‚Äôs dare (‚â§50 chars)" />
<button id="confirmDare" class="btn btn-primary" type="button">Break the news</button>
</div>
</div>
</div>
</template>

<script>
"use strict";

/* Helpers */
const $=id=>document.getElementById(id);
const qs=new URLSearchParams(location.search);
const toast=$("toast");
function say(t,ms=1600){ toast.textContent=t; toast.classList.remove("hidden"); clearTimeout(say._t); say._t=setTimeout(()=>toast.classList.add("hidden"),ms); }
function ringPoints(N){ const L=8,R=92,T=12,B=88,cx=(L+R)/2,cy=(T+B)/2,rx=(R-L)/2,ry=(B-T)/2; const out=[]; for(let i=0;i<N;i++){const a=(2*Math.PI*i)/N-Math.PI/2; out.push({x:cx+rx*Math.cos(a),y:cy+ry*Math.sin(a)})} return out; }
function uuid(){ try{ return crypto.randomUUID() } catch(e){ return Math.random().toString(36).slice(2) } }

/* Elements */
const hostMount=$("hostMount"), tableWrap=$("tableWrap"), board=$("board");
const revealView=$("revealView"), resetBtn=$("resetBtn");

/* State */
let gameId = qs.get("g") || null;
let state = null;
let pollTimer=null;
let me = {
isHost: !gameId,
myName: null,
tappedOnce: false,
inviteShared: false,
clientId: (()=>{ try{ let v=localStorage.getItem("td_client"); if(!v){ v=uuid(); localStorage.setItem("td_client", v); } return v; }catch(_){ return uuid(); } })(),
penultShown: false // blocks accidental double-modal
};

/* Mount views */
if (me.isHost) {
// Inject host UI only for true host (no ?g=)
const tpl=document.getElementById("hostTpl").content.cloneNode(true);
hostMount.appendChild(tpl);
const hostSetup=$("hostSetup");
const nameFields=$("nameFields");
const confirmBtn=$("confirmBtn");
resetBtn.classList.remove("hidden");

const inputs=[...nameFields.querySelectorAll("input")];
const getNames=()=>inputs.map(i=>i.value.trim()).filter(Boolean).slice(0,10);
inputs.forEach(inp=>inp.addEventListener("input",()=>{
const n=getNames(); confirmBtn.disabled = n.length<3; drawTable(n, []);
}, {passive:true}));

confirmBtn.onclick=async ()=>{
const names=getNames();
if (names.length<3){ say("Add at least 3 names"); return; }
const res = await fetch("/api/game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({names})});
const data = await res.json();
if (!res.ok){ say(data.error || "Create failed"); return; }
gameId = data.gameId; state = data.state;

history.replaceState(null,"",location.pathname+"?g="+gameId);
hostMount.innerHTML=""; resetBtn.classList.add("hidden");
tableWrap.classList.remove("hidden");
drawTable(state.names, state.tapped);
startPolling();
say("Names confirmed. Tap your own name to share the invite.");
};

resetBtn.onclick=()=>{ location.href = location.pathname + "?ts=" + Date.now(); };
} else {
tableWrap.classList.remove("hidden");
fetchState();
}

/* Polling */
function startPolling(){ stopPolling(); pollTimer=setInterval(fetchState,2000); window.addEventListener("focus",fetchState); }
function stopPolling(){ if(pollTimer){clearInterval(pollTimer);pollTimer=null;} window.removeEventListener("focus",fetchState); }

async function fetchState(){
if(!gameId) return;
const res = await fetch("/api/state?gameId="+encodeURIComponent(gameId));
const s = await res.json();
if(!res.ok){ say(s.error||"Connection error"); return; }
state=s;
if(state.revealed){ showReveal(); return; }
drawTable(state.names, state.tapped);

// If not penultimate on THIS device, ensure any modal is removed
ensureNoPenultModalUnlessEligible();
}

/* Render */
function drawTable(names,tapped){
board.innerHTML="";
if(!Array.isArray(names)||!names.length) return;
const pts=ringPoints(names.length);
names.forEach((nm,i)=>{
const down=tapped.includes(nm);
const chip=document.createElement("div");
chip.className="chip"+(down?" down":"");
chip.style.left=pts[i].x+"%"; chip.style.top=pts[i].y+"%";
chip.dataset.name=nm;
chip.innerHTML=`<div class="ic">${down?"üëé":"üëç"}</div><div class="nm">${nm}</div>`;
chip.addEventListener("click",()=>onTap(nm,chip),{passive:true});
board.appendChild(chip);
});

// If this device already tapped, disable others locally
if(me.tappedOnce && me.myName){
[...board.querySelectorAll(".chip")].forEach(c=>{ if(c.dataset.name!==me.myName) c.classList.add("disabled"); });
}
}

/* Tap flow */
async function onTap(name,chip){
if(!gameId||!state) return;
if(state.revealed) return;
if(state.tapped.includes(name)) return;
if(me.tappedOnce && me.myName && me.myName!==name) return;

// Optimistic
chip.classList.add("down");
chip.querySelector(".ic").textContent="üëé";
me.tappedOnce=true; me.myName=name;

// Host: first tap ‚Üí WhatsApp invite with explicit ?g=
if(me.isHost && !me.inviteShared && gameId){
me.inviteShared=true;
const inviteURL = location.origin + location.pathname + "?g=" + encodeURIComponent(gameId);
const text = `Thumbs Down ‚Äî Don‚Äôt Be Such a Loser\n${inviteURL}`;
setTimeout(()=>{ location.href="https://wa.me/?text="+encodeURIComponent(text); }, 900);
}

// Send to server with clientId
const res = await fetch("/api/tap",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({gameId, name, clientId: me.clientId})
});
const s = await res.json();
if(!res.ok){ say(s.error||"Tap failed"); await fetchState(); return; }
state=s;

// Use authoritative response to decide penultimate status
maybeShowPenultimate();
drawTable(state.names, state.tapped);
}

/* Penultimate gating */
function maybeShowPenultimate(){
// Only if exactly one name remains AND this device is in tapped
const remaining = state.names.length - state.tapped.length;
const iAmTapped = me.myName && state.tapped.includes(me.myName);
if (remaining === 1 && iAmTapped && !me.penultShown) {
const loser = state.names.find(n => !state.tapped.includes(n)) || "someone";
openPenultModal(loser);
me.penultShown = true;
} else if (!(remaining === 1 && iAmTapped)) {
// If condition no longer true, ensure modal gone
closePenultModal();
me.penultShown = false;
}
}

function ensureNoPenultModalUnlessEligible(){
const remaining = state.names.length - state.tapped.length;
const iAmTapped = me.myName && state.tapped.includes(me.myName);
if (!(remaining === 1 && iAmTapped)) {
closePenultModal();
me.penultShown = false;
}
}

/* Modal mount/unmount */
function openPenultModal(loserName){
closePenultModal(); // just in case
const tpl = document.getElementById("penultTpl").content.cloneNode(true);
document.body.appendChild(tpl);
const modal = document.getElementById("penultModal");
document.getElementById("loserName").textContent = loserName;

document.getElementById("confirmDare").onclick = async ()=>{
const dareInput = document.getElementById("dareInput");
const dv = (dareInput.value||"").trim().slice(0,50);
if(!dv){ say("Type a dare first"); return; }

const res = await fetch("/api/reveal",{
method:"POST", headers:{"Content-Type":"application/json"},
body:JSON.stringify({gameId, dare: dv})
});
const s = await res.json();
if(!res.ok){ say(s.error||"Reveal failed"); return; }
state = s;

const revealURL = location.origin + location.pathname + "?g=" + encodeURIComponent(gameId);
const text = `üëâ Click to reveal today‚Äôs massive loser:\n${revealURL}`;
location.href = "https://wa.me/?text="+encodeURIComponent(text);

showReveal();
closePenultModal();
};

// Prevent backdrop click from closing (we want them to finish)
modal.addEventListener("click", (e)=>{ if(e.target===modal){ /* do nothing */ } }, {passive:true});
}

function closePenultModal(){
const m = document.getElementById("penultModal");
if (m) m.remove();
}

/* Reveal */
function showReveal(){
stopPolling();
$("appView").classList.add("hidden");
revealView.classList.remove("hidden");
$("headline").textContent = `Today‚Äôs massive loser: ${state.loser||"Someone"}`;
$("dareLine").textContent = state.dare ? `Your dare is: ${state.dare}` : "";
$("meta").textContent = new Date().toLocaleString();
}

/* Toast errors */
window.addEventListener('error',e=>{ try{ say('Error: '+(e.message||'unknown')); }catch(_){} });
</script>
</body>
</html>
