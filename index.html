<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Thumbs Down</title>
<meta name="theme-color" content="#111111"/>

<!-- Social preview -->
<meta property="og:title" content="Thumbs Down" />
<meta property="og:description" content="Tap fast. Last one down faces a task." />
<meta property="og:type" content="website" />
<meta property="og:image" content="/Thumbs Down.png" />
<meta property="og:url" content="https://thumbsdown.netlify.app/" />

<style>
:root{
--cream:#F7F1E6;
--ink:#0F0F10;
--card:#101114;
--card2:#0c0d10;
--green-filter:hue-rotate(90deg) saturate(1.2);
--muted:#c8ccd2;
--radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
margin:0;
background:var(--cream);
color:var(--ink);
font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* Header: logo (thumb left), big title one line, tagline beneath */
header{
max-width:680px; margin:16px auto 10px; padding:0 16px;
display:flex; align-items:flex-end; gap:14px; flex-wrap:nowrap;
}
.logo-mark{ font-size:36px; line-height:1; transform:rotate(180deg); filter:var(--green-filter); }
.title-wrap{ display:flex; flex-direction:column; gap:6px; min-width:0; flex:1; }
.brand{ display:flex; align-items:baseline; gap:10px; white-space:nowrap; overflow:hidden; }
.brand h1{ margin:0; font-weight:800; letter-spacing:.2px; font-size:clamp(22px,6vw,34px); }
.tag{ margin:0; color:#2b2e31; font-style:italic; font-size:clamp(13px,3.2vw,16px); text-align:right; opacity:.9; }

/* Main card (black box) */
.card{
max-width:680px; margin:0 auto 18px; padding:16px;
background:linear-gradient(180deg,var(--card),var(--card2));
color:#fff; border-radius:var(--radius);
box-shadow:0 10px 30px rgba(0,0,0,.25);
}

/* Host setup */
.hint{ color:#d0d3d8; font-size:13px; margin:4px 0 10px; }
.names-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
.names-grid input{
width:100%; border-radius:10px; background:#181a1f; color:#fff;
border:1px solid #292c33; padding:10px 12px; font-size:15px;
}
.row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; }
.btn{ appearance:none; border:0; border-radius:10px; padding:10px 14px; font-weight:700; font-size:14px; cursor:pointer; }
.btn.primary{ background:#21c063; color:#05230f; }
.btn.ghost{ background:#25272c; color:#e7eaee; }
.btn.small{ padding:8px 12px; font-size:13px; }

/* Table (thumbs grid) */
.table-area{ margin-top:12px; }
.thumbs{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px; justify-items:center; align-items:center; }
.person{ display:flex; flex-direction:column; align-items:center; gap:2px; }
.thumb{
font-size:34px; line-height:1; background:transparent; border:0; cursor:pointer;
transition:transform .22s ease, opacity .2s ease;
filter:drop-shadow(0 1px 0 rgba(0,0,0,.35));
}
.thumb.down{ transform:rotate(180deg); filter:var(--green-filter) drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
.thumb.locked{ opacity:.6; cursor:default; }
.name{ margin-top:4px; font-size:12px; color:#cfd3d9; text-align:center; width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Punisher modal */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:flex-end; justify-content:center; padding:16px; }
.modal.show{ display:flex; }
.sheet{
width:100%; max-width:680px; background:#0f1013; color:#fff; border-radius:16px 16px 12px 12px;
padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.45);
}
.sheet h3{ margin:0 0 8px; font-size:18px; }
.sheet p{ margin:0 0 10px; color:#cdd2d8; font-size:14px; }
.sheet textarea{
width:100%; min-height:80px; background:#181a1e; border:1px solid #2a2c31;
color:#fff; border-radius:12px; padding:10px; font-size:14px;
}
.actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }

/* Toast */
#toast{
position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
background:#111; color:#fff; padding:8px 12px; border-radius:8px;
opacity:0; pointer-events:none; transition:opacity .2s;
}
#toast.show{ opacity:.95; }

@media (max-width:420px){
.names-grid{ grid-template-columns:1fr; }
.thumbs{ grid-template-columns:repeat(4,1fr); }
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
<div class="logo-mark" aria-hidden="true">👎</div>
<div class="title-wrap">
<div class="brand"><h1>THUMBS&nbsp;DOWN</h1></div>
<p class="tag">Tap fast. Last one down faces a task.</p>
</div>
</header>

<!-- CARD -->
<main class="card">
<!-- HOST SETUP (hidden for players who join via ?g=...) -->
<div id="host-setup">
<div class="hint">Add up to 10 friends</div>
<div class="names-grid" id="nameInputs"></div>
<div class="row">
<button class="btn ghost small" id="resetBtn" type="button">Reset</button>
<button class="btn primary small" id="confirmBtn" type="button">Confirm</button>
</div>
</div>

<!-- TABLE -->
<div class="table-area" id="tableArea" hidden>
<div class="thumbs" id="thumbs"></div>
</div>
</main>

<!-- PUNISHER MODAL (penultimate tap only) -->
<div class="modal" id="punisherModal" aria-hidden="true">
<div class="sheet" role="dialog" aria-modal="true" aria-labelledby="punishTitle">
<h3 id="punishTitle">Congratulations — you’re the Punisher</h3>
<p id="punishText">The person who didn’t tap their name is <strong id="loserName">TBD</strong>. Set their dare or task below, then share it back to the group.</p>
<textarea id="dareText" maxlength="200" placeholder="Type the dare or task (max 200 chars)"></textarea>
<div class="actions">
<button class="btn ghost" id="closePunisher">Cancel</button>
<button class="btn primary" id="sharePunisher">Share back to your group</button>
</div>
</div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
/* ---------------- helpers & globals ---------------- */
const $ = sel => document.querySelector(sel);
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }

// persistent device id (one tap per device per game)
function getClientId(){
const k='td-client-id';
let v=localStorage.getItem(k);
if(!v){ v=(crypto.randomUUID?crypto.randomUUID(): Date.now()+Math.random().toString(36).slice(2)); localStorage.setItem(k,v); }
return v;
}
const clientId = getClientId();

// current game id for this page (host after Confirm, or player via ?g=)
let currentGameId = null;

// keep last state (no heavy use; render always receives gameId explicitly)
let lastState = null;

/* ---------------- build host inputs ---------------- */
const nameInputsEl = $("#nameInputs");
for (let i=0;i<10;i++){
const inp = document.createElement('input');
inp.type = 'text';
inp.placeholder = `Name ${i+1}`;
inp.autocapitalize = 'words';
nameInputsEl.appendChild(inp);
}

/* ---------------- API helpers ---------------- */
async function apiCreate(names){
const r = await fetch('/api/game',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({names})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'create failed'); return d; // { gameId, state }
}
async function apiState(gameId){
const r = await fetch(`/api/state?gameId=${encodeURIComponent(gameId)}`);
const d = await r.json(); if(!r.ok) throw new Error(d.error||'state failed'); return d;
}
async function apiTap(gameId,name){
const r = await fetch('/api/tap',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({gameId,name,clientId})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'tap failed'); return d;
}
async function apiReveal(gameId,dare){
const r = await fetch('/api/reveal',{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({gameId,dare})});
const d = await r.json(); if(!r.ok) throw new Error(d.error||'reveal failed'); return d;
}

/* ---------------- render ---------------- */
function render(stateWithId){
lastState = stateWithId;
const { gameId, names, tapped } = stateWithId;

// show table (hide host setup if still visible)
$("#tableArea").hidden = false;

const wrap = $("#thumbs"); wrap.innerHTML = '';
names.forEach(n=>{
const isDown = tapped.includes(n);
const cell = document.createElement('div'); cell.className='person';
const btn = document.createElement('button'); btn.className='thumb'; btn.type='button';
btn.textContent = isDown ? '👎' : '👍';
if(isDown) btn.classList.add('down');
btn.addEventListener('click', ()=> onTap(n, btn));
const label = document.createElement('div'); label.className='name'; label.textContent = n;
cell.appendChild(btn); cell.appendChild(label);
wrap.appendChild(cell);
});

// device one-tap lock
const locked = localStorage.getItem(`td-lock-${gameId}`);
if (locked){
document.querySelectorAll('.thumb').forEach(b=>{
b.disabled = true;
if(!b.classList.contains('down')) b.classList.add('locked');
});
}

// if penultimate (exactly one remaining) and this device has tapped → show modal
const remaining = names.filter(n=>!tapped.includes(n));
if (remaining.length === 1 && locked){
$("#loserName").textContent = remaining[0];
$("#punisherModal").classList.add('show');
$("#punisherModal").setAttribute('aria-hidden','false');
} else {
$("#punisherModal").classList.remove('show');
$("#punisherModal").setAttribute('aria-hidden','true');
}
}

/* ---------------- actions ---------------- */
$("#confirmBtn").addEventListener('click', async ()=>{
try{
const names = [...nameInputsEl.querySelectorAll('input')].map(i=>i.value.trim()).filter(Boolean).slice(0,10);
if(names.length < 3){ toast('Add at least 3 names'); return; }

const { gameId, state } = await apiCreate(names);

// remember game id globally (fixes "Missing game ID")
currentGameId = gameId;

// hide host UI so players never see inputs on join
$("#host-setup").style.display = 'none';

// render with table
render({ ...state, gameId });

// update URL with ?g= for sharing
history.replaceState(null,'',`?g=${encodeURIComponent(gameId)}`);

toast('Game created. Tap your name to start!');
}catch(e){ toast(e.message); }
});

$("#resetBtn").addEventListener('click', ()=>{
[...nameInputsEl.querySelectorAll('input')].forEach(i=> i.value='');
try{ localStorage.clear(); }catch(_){}
location.href='/';
});

async function onTap(canonicalName, el){
if (!currentGameId){
toast('Still setting up… please try again');
return;
}
// block double tap from same device in this game
if (localStorage.getItem(`td-lock-${currentGameId}`)){
el.classList.add('wobble'); setTimeout(()=>el.classList.remove('wobble'),250);
return;
}

// optimistic flip
el.classList.add('down'); el.textContent='👎';
try{
const state = await apiTap(currentGameId, canonicalName);
// lock this device
localStorage.setItem(`td-lock-${currentGameId}`, canonicalName);
render({ ...state, gameId: currentGameId });
}catch(e){
el.classList.remove('down'); el.textContent='👍';
toast(e.message);
}
}

/* ---------------- punisher modal ---------------- */
$("#closePunisher").addEventListener('click', ()=>{
$("#punisherModal").classList.remove('show');
$("#punisherModal").setAttribute('aria-hidden','true');
});

$("#sharePunisher").addEventListener('click', async ()=>{
if (!currentGameId) return;
const dare = ($("#dareText").value || '').trim();
try{
const state = await apiReveal(currentGameId, dare);
$("#punisherModal").classList.remove('show');
$("#punisherModal").setAttribute('aria-hidden','true');

const url = location.origin + `/?g=${encodeURIComponent(currentGameId)}&reveal=1`;
const text = `Thumbs Down — result:\n\nLoser: ${state.loser || 'unknown'}\nTask: ${state.dare || '(none)'}\n\nOpen: ${url}`;
const wa = `https://wa.me/?text=${encodeURIComponent(text)}`;

if (navigator.share){
try { await navigator.share({ title:'Thumbs Down', text }); }
catch(_) { location.href = wa; }
} else {
location.href = wa;
}
}catch(e){ toast(e.message); }
});

/* ---------------- hydrate on load (player join) ---------------- */
(async function init(){
const g = new URLSearchParams(location.search).get('g');
if (g){
// joining a running game → hide host inputs
$("#host-setup").style.display='none';
try{
const s = await apiState(g);
currentGameId = g; // remember id (fixes missing id for taps)
render({ ...s, gameId: g });
}catch(e){ toast(e.message); }
}
})();
</script>
</body>
</html>

